# abr-geocoder
デジタル庁 アドレス・ベース・レジストリ ジオコーダー
- 町字IDを付与する
- アドレス（住所・所在地）文字列を正規化する
- 緯度経度とマッチングレベルを出力する

## インデックス
- [abr-geocoder](#abr-geocoder)
  - [インデックス](#インデックス)
  - [ドキュメント](#ドキュメント)
  - [使用環境](#使用環境)
  - [ビルドとインストール](#ビルドとインストール)
  - [使い方](#使い方)
    - [`download`](#download)
    - [`update-check`](#update-check)
    - [`normalize`](#normalize)
      - [利用可能なオプション](#利用可能なオプション)
    - [`nd`接頭辞](#nd接頭辞)
    - [曖昧一致](#曖昧一致)
  - [出力結果のフォーマット](#出力結果のフォーマット)
    - [`json`](#json)
    - [`geojson`](#geojson)
    - [マッチングレベルについて](#マッチングレベルについて)

## ドキュメント
- [このプロジェクトへの参加について](docs/CONTRIBUTING.ja.md)

-------

## 使用環境

コマンドを実行するためには **node.js version 18以上** が必要です。

## ビルドとインストール

まだ開発中なため、現時点では `npm`パッケージを提供していません。
インストールするためには、あなたのPC上でソースコードからビルドする必要があります。

```
$ git clone git@github.com:digital-go-jp/abr-geocoder.git
$ cd abr-geocoder
$ npm i
$ npm run build
```

グローバルにインストールする場合
```
(global install)
$ npm -g install .
$ abrg --version
```

または `npx` コマンドを併用する場合
```
(local usage)
$ npx abrg --version
```

## 使い方

```
$ abrg download # アドレス・ベース・レジストリのデータをダウンロードし、データベース作成を行う
$ echo "東京都千代田区紀尾井町1-3　東京ガーデンテラス紀尾井町 19階、20階" | abrg normalize -
```

### `download`

サーバーから最新データを取得します。

```
$ abrg download
```

アドレス・ベース・レジストリの[「全アドレスデータ」](https://catalog.registries.digital.go.jp/rc/dataset/ba000001) を `$HOME/.abr-geocoder` ディレクトリにダウンロードし、SQLiteを使ってデータベースを構築します。

作成済みのデータベースを更新するには、`abrg download` を実行します。

### `update-check`

データのアップデートの有無を確認する。

```
$ abrg update-check
```

最新である場合は戻り値 `0` を返し、正常終了します。
CKANに新しいデータが存在する場合（ローカルのデータを確認できなかった場合を含む）は、戻り値 `1` を返し、異常終了します。

新しいデータがある場合は、`download` サブコマンドで更新してください。

### `normalize`

アドレスをジオコーディングする。

```
$ abrg normalize [options] <inputFile>
```

`<inputFile>` で指定されたテキストファイルをジオコーディングします。
１行単位（１行につき１つのアドレス）で記入してください。

例：
```sample.txt
東京都千代田区紀尾井町1-3
東京都千代田区永田町1-10-1
...
東京都千代田区永田町一丁目7番1号
```

標準入力からデータを渡したい場合は、 '-' を指定することができます。
```
echo "東京都千代田区紀尾井町1-3　東京ガーデンテラス紀尾井町 19階、20階" | abrg normalize -
```


#### 利用可能なオプション

- `-f`, `--format`

   出力書式を指定します。デフォルトは `table`で、CLI上に表を出力します。
   `json` や `geojson`を指定することも出来ます。

- `--fuzzy`

   アドレスの中に`?`を含むことを許可します。
  
- `-h`, `--help`

   コマンドの使い方を表示します。

主なオプションは `--format` となります。デフォルトは `table` に設定し、CLI上に表型に表示されます。
JSONの出力や、GeoJSONの出力のサンプルは下記「出力結果のフォーマット」をご確認ください。

### `nd`接頭辞

`nd`接頭辞を付けて出力書式を指定する（例：`ndjson`) と、1つのアドレスを処理する毎に結果を出力します。

`nd`を付けない場合は、全行処理後に結果を出力します。

### 曖昧一致

`?` のワイルドカードを利用して曖昧一致させることができます。 `--fuzzy` オプションを利用してください。

```
$ echo '東京都千代?区紀尾井町1-3　東京ガーデンテラス紀尾井町 19階、20階' | abrg normalize --format=ndjson -
{"pref":"東京都","city":"","town":"","other":"千代?区紀尾井町1-3 東京ガーデンテラス紀尾井町 19階、20階","lat":null,"lon":null,"level":1}

$ echo '東京都千代田区紀尾?町1-3　東京ガーデンテラス紀尾井町 19階、20階' | abrg normalize --fuzzy --format=ndjson -
{"pref":"東京都","city":"千代田区","lg_code":"131016","town":"紀尾井町","town_id":"0056000","other":"東京ガーデンテラス紀尾井町 19階、20階","lat":35.679107172,"lon":139.736394597,"level":8,"addr1":"3","blk":"1","blk_id":"001","addr1_id":"003","addr2":"","addr2_id":""}
```

## 出力結果のフォーマット

### `json`

```
[
  {
    "pref": "東京都", // 都道府県名
    "city": "千代田区", // 市区町村名
    "lg_code": "131016", // 全国地方公共団体コード
    "town": "紀尾井町", // 町字
    "town_id": "0056000", // 町字ID
    "blk": "1", // 街区符号
    "blk_id": "001", // 街区ID
    "addr1": "3", // 住居番号
    "addr1_id": "003",// 住居ID
    "addr2": "", // 住居番号2
    "addr2_id": "", // 住居2ID
    "other": "東京ガーデンテラス紀尾井町 19階、20階", // 正規化できなかった部分
    "level": 8, // マッチングレベル
    "lat": 35.679107172, // 代表点_緯度
    "lon": 139.736394597 // 代表点_経度
  }
]
```

### `geojson`

```
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          139.736394597,
          35.679107172
        ]
      },
      "properties": {
        "title": "東京都千代田区紀尾井町1-3",
        "level": 8,
        "pref": "東京都",
        "city": "千代田区",
        "lg_code": "131016",
        "town": "紀尾井町",
        "town_id": "0056000",
        "blk": "1",
        "blk_id": "001",
        "addr1": "3",
        "addr1_id": "003",
        "addr2": "",
        "addr2_id": "",
        "other": "東京ガーデンテラス紀尾井町 19階、20階"
      }
    }
  ]
}
```

### マッチングレベルについて

JSON / GeoJSON 出力を利用する場合は `level` プロパティに入ってます。

`level` プロパティは、マッチしたアドレスの精度を示しています。`json`または`geojson`を出力書式に指定した場合のみ利用可能です。

| level | description |
|-------|-------------|
| 0 | 全く判定できなかった |
| 1 | 都道府県レベルまで判別できた |
| 2 | 市区町村まで判別できた |
| 3 | 町字まで判別できた |
| 7 | 住居表示の街区までの判別ができた |
| 8 | 住居表示の街区符号・住居番号までの判別ができた |
